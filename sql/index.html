<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SQL Server Execution Plan Operators</title>
<style>
  :root {
    --bg: #1a1a2e;
    --surface: #16213e;
    --surface2: #0f3460;
    --accent: #e94560;
    --text: #eee;
    --text-dim: #999;
    --border: #2a2a4a;
    --green: #4ecca3;
    --yellow: #f0c040;
    --blue: #53a8f0;
    --icon-bg: rgba(255,255,255,0.08);
    --perf-bg: rgba(233, 69, 96, 0.1);
    --badge-bg: rgba(255,255,255,0.06);
    --detail-text: #ccc;
    --modal-bg: rgba(0,0,0,0.7);
    --modal-surface: #1a1a2e;
    --modal-border: #2a2a4a;
    --msdoc-bg: rgba(255,255,255,0.03);
    --msdoc-border: rgba(255,255,255,0.1);
    --diagram-text: #e6edf3;
    --diagram-dim: #8b949e;
    --diagram-surface: #161b22;
    --diagram-border: #30363d;
    --diagram-accent: #58a6ff;
    --diagram-green: #4ecca3;
    --diagram-yellow: #f0c040;
  }
  [data-theme="light"] {
    --bg: #f0f2f5;
    --surface: #fff;
    --surface2: #e8edf2;
    --accent: #d63050;
    --text: #1a1a2e;
    --text-dim: #666;
    --border: #d0d5dd;
    --green: #2a8a6a;
    --yellow: #b08a20;
    --blue: #2070c0;
    --icon-bg: rgba(0,0,0,0.06);
    --perf-bg: rgba(214, 48, 80, 0.08);
    --badge-bg: rgba(0,0,0,0.05);
    --detail-text: #444;
    --modal-bg: rgba(0,0,0,0.5);
    --modal-surface: #fff;
    --modal-border: #d0d5dd;
    --msdoc-bg: rgba(0,0,0,0.02);
    --msdoc-border: rgba(0,0,0,0.08);
    --diagram-text: #1f2328;
    --diagram-dim: #656d76;
    --diagram-surface: #fff;
    --diagram-border: #d0d7de;
    --diagram-accent: #0969da;
    --diagram-green: #2a8a6a;
    --diagram-yellow: #b08a20;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }
  .container { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }
  h1 { font-size: 1.6rem; margin-bottom: 4px; }
  .subtitle { color: var(--text-dim); font-size: 0.9rem; margin-bottom: 24px; }
  .subtitle a { color: var(--blue); text-decoration: none; }
  .subtitle a:hover { text-decoration: underline; }

  .search-wrap { position: relative; margin-bottom: 20px; }
  #search {
    width: 100%; padding: 14px 16px 14px 44px; font-size: 1rem;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; color: var(--text); outline: none; transition: border-color 0.2s;
  }
  #search:focus { border-color: var(--accent); }
  #search::placeholder { color: var(--text-dim); }
  .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-dim); font-size: 1.2rem; pointer-events: none; }
  .result-count { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--text-dim); font-size: 0.8rem; }

  .filters { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
  .filter-btn {
    padding: 6px 14px; font-size: 0.8rem; border-radius: 20px;
    border: 1px solid var(--border); background: var(--surface);
    color: var(--text-dim); cursor: pointer; transition: all 0.2s;
  }
  .filter-btn:hover { border-color: var(--accent); color: var(--text); }
  .filter-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  .ops-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
  .op-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.2s;
  }
  .op-card:hover { border-color: var(--accent); transform: translateY(-1px); }
  .op-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
  .op-icon {
    width: 40px; height: 40px; border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; background: var(--icon-bg);
    padding: 4px;
  }
  .op-icon img {
    width: 32px; height: 32px; image-rendering: pixelated;
  }
  .op-name { font-weight: 600; font-size: 0.95rem; }
  .op-type { font-size: 0.7rem; color: var(--text-dim); margin-top: 2px; text-transform: uppercase; letter-spacing: 0.5px; }
  .op-summary { font-size: 0.85rem; color: var(--text-dim); line-height: 1.4; }

  /* Modal styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--modal-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }
  .modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }
  .modal {
    background: var(--modal-surface);
    border: 1px solid var(--modal-border);
    border-radius: 12px;
    max-width: 700px;
    width: 90vw;
    max-height: 90vh;
    overflow: hidden;
    transform: scale(0.9);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
  }
  .modal-overlay.active .modal {
    transform: scale(1);
  }
  .modal-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--modal-border);
    display: flex;
    align-items: center;
    gap: 16px;
    position: relative;
  }
  .modal-icon {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    background: var(--icon-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    padding: 4px;
  }
  .modal-icon img {
    width: 40px;
    height: 40px;
    image-rendering: pixelated;
  }
  .modal-title {
    flex: 1;
  }
  .modal-title h2 {
    font-size: 1.4rem;
    margin-bottom: 6px;
  }
  .modal-badges {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
  }
  .modal-category-badge {
    background: var(--accent);
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  .modal-type-badge {
    background: var(--badge-bg);
    color: var(--text-dim);
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
  }
  .modal-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    border: none;
    background: var(--badge-bg);
    color: var(--text-dim);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.2s;
  }
  .modal-close:hover {
    background: var(--accent);
    color: white;
  }
  .modal-content {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
  }
  .modal-section {
    margin-bottom: 24px;
  }
  .modal-section:last-child {
    margin-bottom: 0;
  }
  .modal-section-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text);
  }
  .modal-section-content {
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--detail-text);
  }
  .modal-section-content p {
    margin-bottom: 12px;
  }
  .modal-section-content p:last-child {
    margin-bottom: 0;
  }
  .perf-tip {
    padding: 16px;
    border-radius: 8px;
    background: var(--perf-bg);
    border-left: 4px solid var(--accent);
    font-size: 0.85rem;
    line-height: 1.5;
  }
  .perf-tip strong {
    color: var(--accent);
  }
  .msdoc-section {
    background: var(--msdoc-bg);
    border: 1px solid var(--msdoc-border);
    border-radius: 8px;
    padding: 20px;
  }
  .msdoc-section .modal-section-content {
    font-size: 0.88rem;
  }

  .hidden { display: none !important; }
  .theme-toggle {
    position: fixed; top: 16px; right: 16px; z-index: 100;
    width: 44px; height: 44px; border-radius: 50%;
    border: 1px solid var(--border); background: var(--surface);
    color: var(--text); font-size: 1.2rem; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  .theme-toggle:hover { border-color: var(--accent); transform: scale(1.1); }
  @media (max-width: 700px) { 
    .ops-grid { grid-template-columns: 1fr; }
    .modal {
      width: 95vw;
      max-height: 95vh;
    }
    .modal-header {
      padding: 16px 20px 12px;
    }
    .modal-content {
      padding: 20px;
    }
  }
</style>
</head>
<body>
<button class="theme-toggle" id="themeToggle" title="Toggle light/dark mode">üåô</button>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon" id="modalIcon">‚öôÔ∏è</div>
      <div class="modal-title">
        <h2 id="modalName">Operator Name</h2>
        <div class="modal-badges">
          <span class="modal-category-badge" id="modalCategory">Category</span>
          <div id="modalTypes"></div>
        </div>
      </div>
      <button class="modal-close" id="modalClose">&times;</button>
    </div>
    <div class="modal-content">
      <div class="modal-section">
        <div class="modal-section-title">Quick Summary</div>
        <div class="modal-section-content" id="modalSummary"></div>
      </div>
      <div class="modal-section" id="diagramSection" style="display: none;">
        <div class="modal-section-title">How It Works</div>
        <div id="modalDiagram" style="max-width:520px; margin: 0 auto;"></div>
      </div>
      <div class="modal-section" id="perfSection" style="display: none;">
        <div class="modal-section-title">Performance Tip</div>
        <div class="perf-tip" id="modalPerf"></div>
      </div>
      <div class="modal-section">
        <div class="modal-section-title">Microsoft Documentation</div>
        <div class="msdoc-section">
          <div class="modal-section-content" id="modalMsDoc"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <nav style="font-size:0.85rem;margin-bottom:12px;color:var(--text-dim)">
    <a href="/" style="color:var(--blue);text-decoration:none">üè† Home</a><span style="margin:0 6px">/</span><a href="/sql/" style="color:var(--blue);text-decoration:none">SQL Tools</a><span style="margin:0 6px">/</span><span>Operator Reference</span>
  </nav>
  <h1>‚ö° SQL Server Execution Plan Operators</h1>
  <p class="subtitle">Quick reference ‚Äî click any operator for full details. Source: <a href="https://learn.microsoft.com/en-us/sql/relational-databases/showplan-logical-and-physical-operators-reference" target="_blank">Microsoft Docs</a></p>
  <div class="search-wrap">
    <span class="search-icon">üîç</span>
    <input type="text" id="search" placeholder="Search operators... (e.g. 'scan', 'join', 'lookup', 'hash')" autocomplete="off">
    <span class="result-count" id="resultCount"></span>
  </div>
  <div class="filters" id="filters"></div>
  <div class="ops-grid" id="grid"></div>
</div>

<script src="operators.js"></script>
<script>
const _operators = operators; // already loaded from operators.js
const _operatorMap = operatorMap;

function formatMsDoc(text) {
  return text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/(?<!\*)\*([^*]+?)\*(?!\*)/g, '<em>$1</em>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/^/, '<p>')
    .replace(/$/, '</p>');
}

const categoryStyles = {
  "Data Access": "data-access", "Joins": "join", "Sort & Grouping": "sort-group",
  "Modify": "modify", "Spools": "spool", "Parallelism": "parallel",
  "Cursors": "cursor", "Other": "other"
};
const categories = Object.keys(categoryStyles);

function fuzzyScore(query, text) {
  query = query.toLowerCase(); text = text.toLowerCase();
  if (text.includes(query)) return 100 + (query.length / text.length * 50);
  let qi = 0, score = 0, lastMatch = -1;
  for (let ti = 0; ti < text.length && qi < query.length; ti++) {
    if (text[ti] === query[qi]) {
      score += (ti === lastMatch + 1) ? 15 : 5;
      if (ti === 0 || text[ti-1] === ' ' || text[ti-1] === '(') score += 10;
      lastMatch = ti; qi++;
    }
  }
  return qi === query.length ? score : 0;
}

function matchOperator(op, query) {
  if (!query) return 100;
  let best = 0;
  for (const f of [op.name, op.summary, op.detail, op.category, ...(op.types || [])]) {
    best = Math.max(best, fuzzyScore(query, f));
  }
  return best;
}

const grid = document.getElementById('grid');
const searchInput = document.getElementById('search');
const filtersDiv = document.getElementById('filters');
const resultCountEl = document.getElementById('resultCount');
const modalOverlay = document.getElementById('modalOverlay');
const modalClose = document.getElementById('modalClose');
const modalIcon = document.getElementById('modalIcon');
const modalName = document.getElementById('modalName');
const modalCategory = document.getElementById('modalCategory');
const modalTypes = document.getElementById('modalTypes');
const modalSummary = document.getElementById('modalSummary');
const modalPerf = document.getElementById('modalPerf');
const modalMsDoc = document.getElementById('modalMsDoc');
const perfSection = document.getElementById('perfSection');
const diagramSection = document.getElementById('diagramSection');
const modalDiagram = document.getElementById('modalDiagram');

const operatorDiagrams = {
  "Nested Loops": "diagrams/nested-loops.svg",
};

let activeCategory = null;

function openModal(operator) {
  // Set icon
  modalIcon.innerHTML = `<img src="icons/${operator.icon}.png" alt="${operator.name}" onerror="this.parentElement.textContent='‚öôÔ∏è'">`;
  
  // Set name and category
  modalName.textContent = operator.name;
  modalCategory.textContent = operator.category;
  
  // Set type badges
  modalTypes.innerHTML = (operator.types || []).map(type => 
    `<span class="modal-type-badge">${type}</span>`
  ).join('');
  
  // Set summary
  modalSummary.textContent = operator.summary;
  
  // Set diagram (if exists)
  const diagramPath = operatorDiagrams[operator.name];
  if (diagramPath) {
    fetch(diagramPath).then(r => r.text()).then(svg => {
      modalDiagram.innerHTML = svg;
    });
    diagramSection.style.display = 'block';
  } else {
    diagramSection.style.display = 'none';
    modalDiagram.innerHTML = '';
  }

  // Set performance tip (if exists)
  if (operator.perf) {
    modalPerf.innerHTML = `üí° <strong>Performance:</strong> ${operator.perf}`;
    perfSection.style.display = 'block';
  } else {
    perfSection.style.display = 'none';
  }
  
  // Set Microsoft documentation
  modalMsDoc.innerHTML = formatMsDoc(operator.msDoc || operator.detail);
  
  // Show modal
  modalOverlay.classList.add('active');
}

function closeModal() {
  modalOverlay.classList.remove('active');
}

// Modal event listeners
modalClose.addEventListener('click', closeModal);
modalOverlay.addEventListener('click', (e) => {
  if (e.target === modalOverlay) closeModal();
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
});

const allBtn = document.createElement('button');
allBtn.className = 'filter-btn active';
allBtn.textContent = `All (${operators.length})`;
allBtn.onclick = () => { activeCategory = null; render(); updateFilterBtns(); };
filtersDiv.appendChild(allBtn);

for (const cat of categories) {
  const count = operators.filter(o => o.category === cat).length;
  if (!count) continue;
  const btn = document.createElement('button');
  btn.className = 'filter-btn'; btn.textContent = `${cat} (${count})`; btn.dataset.cat = cat;
  btn.onclick = () => { activeCategory = activeCategory === cat ? null : cat; render(); updateFilterBtns(); };
  filtersDiv.appendChild(btn);
}

function updateFilterBtns() {
  filtersDiv.querySelectorAll('.filter-btn').forEach(b => {
    if (!b.dataset.cat) b.classList.toggle('active', !activeCategory);
    else b.classList.toggle('active', b.dataset.cat === activeCategory);
  });
}

function render() {
  const query = searchInput.value.trim();
  let scored = operators.map(op => ({ op, score: matchOperator(op, query) })).filter(s => s.score > 0);
  if (activeCategory) scored = scored.filter(s => s.op.category === activeCategory);
  scored.sort((a, b) => b.score - a.score);
  resultCountEl.textContent = query ? `${scored.length} result${scored.length !== 1 ? 's' : ''}` : '';
  grid.innerHTML = '';
  
  for (const { op } of scored) {
    const card = document.createElement('div');
    card.className = 'op-card';
    card.innerHTML = `
      <div class="op-header">
        <div class="op-icon"><img src="icons/${op.icon}.png" alt="${op.name}" onerror="this.parentElement.textContent='‚öôÔ∏è'"></div>
        <div>
          <div class="op-name">${op.name}</div>
          <div class="op-type">${op.category}</div>
        </div>
      </div>
      <div class="op-summary">${op.summary}</div>`;
    
    card.addEventListener('click', () => openModal(op));
    grid.appendChild(card);
  }
}

searchInput.addEventListener('input', render);
render();

// Theme toggle
const themeToggle = document.getElementById('themeToggle');
const html = document.documentElement;
const savedTheme = localStorage.getItem('ep-theme');
if (savedTheme === 'light' || (!savedTheme && window.matchMedia('(prefers-color-scheme: light)').matches)) {
  html.setAttribute('data-theme', 'light');
  themeToggle.textContent = '‚òÄÔ∏è';
}
themeToggle.addEventListener('click', () => {
  const isLight = html.getAttribute('data-theme') === 'light';
  html.setAttribute('data-theme', isLight ? 'dark' : 'light');
  themeToggle.textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
  localStorage.setItem('ep-theme', isLight ? 'dark' : 'light');
});
</script>
</body>
</html>